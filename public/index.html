<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Video Transcoder App</title>
  <style>
    :root { --brand:#4CAF50; --brand-2:#45a049; --error:#f44336; --warn:#ff9800; --info:#2196F3; }
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
    .container { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,.1); }
    h1,h2 { color:#333; margin: 0 0 12px; }
    .form-group { margin-bottom: 15px; }
    label { display:block; margin-bottom:5px; font-weight:700; }
    input[type="text"], input[type="password"], input[type="file"], select {
      width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; background:#fff;
    }
    button { background:var(--brand); color:#fff; padding:10px 15px; border:none; border-radius:4px; cursor:pointer; margin-right:10px; }
    button:hover { background:var(--brand-2); }
    button.logout { background:var(--error); }
    button.logout:hover { background:#d32f2f; }
    button.secondary { background:#e9e9e9; color:#333; }
    button.secondary:hover { background:#dcdcdc; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .section { margin-bottom:30px; padding-bottom:20px; border-bottom:1px solid #eee; }
    .job { padding:10px; margin-bottom:10px; background:#f9f9f9; border-radius:4px; border-left:4px solid var(--brand); }
    .job.queued { border-left-color:var(--warn); }
    .job.processing { border-left-color:var(--info); }
    .job.failed { border-left-color:var(--error); }
    .hidden { display:none; }
    .tabs { display:flex; gap:8px; margin-bottom:10px; }
    .tabs button { background:#e9e9e9; color:#333; }
    .tabs button.active { background:#ccc; }
    .card { border:1px solid #eee; padding:16px; border-radius:6px; background:#fafafa; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap: wrap; }
    .notification { position: fixed; top: 20px; right: 20px; padding: 15px; border-radius: 4px; color: #fff; z-index: 1000; opacity: 0; transition: opacity .3s, transform .3s; transform: translateY(-8px); }
    .notification.success { background:var(--brand); }
    .notification.error { background:var(--error); }
    .notification.show { opacity:1; transform: translateY(0); }
    pre.details { white-space:pre-wrap; background:#fff; border:1px solid #eee; padding:8px; border-radius:4px; margin:6px 0 0; }
    small.muted { color:#666; }
  </style>
</head>
<body>
  <div id="notification" class="notification hidden"></div>

  <div class="container">
    <h1>Video Transcoder App</h1>

    <!-- AUTH SECTION -->
    <div id="authSection" class="section">
      <h2>Authentication</h2>
      <div class="tabs">
        <button id="tabLogin"   class="active" onclick="switchAuthTab('login')">Login</button>
        <button id="tabSignup"               onclick="switchAuthTab('signup')">Sign up</button>
        <button id="tabConfirm"              onclick="switchAuthTab('confirm')">Confirm Email</button>
      </div>

      <!-- Login Card -->
      <div id="cardLogin" class="card">
        <div class="form-group">
          <label for="loginUsername">Username</label>
          <input id="loginUsername" type="text" value="client1" />
        </div>
        <div class="form-group">
          <label for="loginPassword">Password</label>
          <input id="loginPassword" type="password" value="password" />
        </div>
        <div class="row">
          <button id="btnLogin" onclick="login()">Login</button>
          <button class="secondary" onclick="switchAuthTab('signup')">Create account</button>
        </div>
      </div>

      <!-- Signup Card -->
      <div id="cardSignup" class="card hidden">
        <div class="form-group">
          <label for="signupUsername">Username</label>
          <input id="signupUsername" type="text" placeholder="e.g. matt" />
        </div>
        <div class="form-group">
          <label for="signupEmail">Email</label>
          <input id="signupEmail" type="text" placeholder="you@example.com" />
        </div>
        <div class="form-group">
          <label for="signupPassword">Password</label>
          <input id="signupPassword" type="password" placeholder="Min 8 chars, upper/lower/number/symbol" />
        </div>
        <div class="row">
          <button id="btnSignup" onclick="signup()">Sign up</button>
          <button class="secondary" onclick="switchAuthTab('confirm')">I have a code</button>
        </div>
      </div>

      <!-- Confirm Card -->
      <div id="cardConfirm" class="card hidden">
        <div class="form-group">
          <label for="confirmUsername">Username</label>
          <input id="confirmUsername" type="text" placeholder="same username as sign-up" />
        </div>
        <div class="form-group">
          <label for="confirmCode">Confirmation Code</label>
          <input id="confirmCode" type="text" placeholder="6-digit code from email" />
        </div>
        <div class="row">
          <button id="btnConfirm" onclick="confirmSignup()">Confirm</button>
          <button class="secondary" onclick="resendCode()">Resend code</button>
        </div>
      </div>
    </div>

    <!-- APP SECTION -->
    <div id="appSection" class="hidden">
      <div class="row" style="justify-content:space-between;">
        <h2>Welcome, <span id="userName"></span></h2>
        <div class="row">
          <label class="row" style="gap:6px;margin:0;">
            <input type="checkbox" id="liveToggle" onchange="toggleLive(this.checked)"> Live updates
          </label>
          <button class="logout" onclick="logout()">Logout</button>
        </div>
      </div>

      <div class="tabs">
        <button id="tabUpload" class="active" onclick="switchAppTab('UploadTab')">Upload Video</button>
        <button id="tabJobs"               onclick="switchAppTab('JobsTab')">My Jobs</button>
        <button id="tabAudit"              onclick="switchAppTab('AuditTab')">Audit</button>
      </div>

      <!-- Upload -->
      <div id="UploadTab" class="card">
        <div class="form-group">
          <label for="videoFile">Video File</label>
          <input id="videoFile" type="file" accept="video/*" />
        </div>
        <div class="form-group">
          <label for="title">Title (optional)</label>
          <input id="title" type="text" placeholder="Video title" />
        </div>
        <div class="form-group">
          <label for="description">Description (optional)</label>
          <input id="description" type="text" placeholder="Video description" />
        </div>
        <div class="form-group">
          <label for="format">Output Format</label>
          <select id="format">
            <option value="mp4" selected>MP4</option>
            <option value="webm">WebM</option>
          </select>
          <small class="muted">Formats supported by backend preset (others will default to MP4).</small>
        </div>
        <div class="form-group">
          <label for="resolution">Resolution</label>
          <select id="resolution">
            <option value="480p">480p</option>
            <option value="720p" selected>720p</option>
            <option value="1080p">1080p</option>
          </select>
        </div>
        <div class="row">
          <button id="btnStart" onclick="uploadVideo()">Start Transcoding</button>
          <button class="secondary" onclick="switchAppTab('JobsTab')">Go to My Jobs</button>
        </div>
      </div>

      <!-- Jobs -->
      <div id="JobsTab" class="card hidden">
        <div class="row" style="align-items:flex-end;">
          <div class="form-group" style="min-width:180px;">
            <label for="statusFilter">Filter by Status</label>
            <select id="statusFilter" onchange="loadJobs()">
              <option value="">All</option>
              <option value="queued">Queued</option>
              <option value="processing">Processing</option>
              <option value="completed">Completed</option>
              <option value="failed">Failed</option>
            </select>
          </div>
          <div class="form-group" style="min-width:180px;">
            <label for="sortBy">Sort By</label>
            <select id="sortBy" onchange="loadJobs()">
              <option value="createdAt">Created Date</option>
              <option value="rawKey">File Name</option>
              <option value="status">Status</option>
            </select>
          </div>
          <div class="form-group" style="min-width:160px;">
            <label for="sortOrder">Sort Order</label>
            <select id="sortOrder" onchange="loadJobs()">
              <option value="DESC">Descending</option>
              <option value="ASC">Ascending</option>
            </select>
          </div>
          <button onclick="loadJobs()">Refresh</button>
        </div>
        <div id="jobsList" style="margin-top:20px;"></div>
      </div>

      <!-- Audit -->
      <div id="AuditTab" class="card hidden">
        <div class="row">
          <div class="form-group" style="margin:0;">
            <label for="auditFilter" style="margin:0;">Filter by action</label>
            <select id="auditFilter" onchange="loadAudit()">
              <option value="">All</option>
              <option value="JOB_CREATED">JOB_CREATED</option>
              <option value="JOB_PROCESSING">JOB_PROCESSING</option>
              <option value="JOB_COMPLETED">JOB_COMPLETED</option>
              <option value="JOB_FAILED">JOB_FAILED</option>
              <option value="DOWNLOAD">DOWNLOAD</option>
            </select>
          </div>
          <button onclick="loadAudit()">Refresh</button>
        </div>
        <div id="auditList" style="margin-top:12px;"></div>
      </div>
    </div>
  </div>

 <script>
  let authToken = null;   // stores Cognito IdToken (or legacy token)
  let currentUser = null;
  let pollHandle;

  // --- SSE (graceful persistent connection) ---
  let es = null;                 // EventSource handle
  let liveEnabled = false;       // persisted in localStorage

  /* ----------------- Small utilities ----------------- */
  function showNotification(message, type = 'success') {
    const el = document.getElementById('notification');
    el.textContent = message;
    el.className = `notification ${type} show`;
    setTimeout(() => (el.className = 'notification hidden'), 2500);
  }
  function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }
  function fileNameFromRawKey(rawKey) {
    if (!rawKey) return '';
    const parts = rawKey.split('/');
    return parts[parts.length - 1] || rawKey;
  }
  function human(dt) { try { return new Date(dt).toLocaleString(); } catch { return dt || ''; } }
  const humanTs = human;

  // Wrapper that auto-injects Authorization and auto-logout on 401
  async function apiFetch(url, options = {}) {
    const headers = new Headers(options.headers || {});
    if (authToken && !headers.has('Authorization')) {
      headers.set('Authorization', 'Bearer ' + authToken);
    }
    if (!headers.has('Content-Type') && options.body && !(options.body instanceof FormData)) {
      headers.set('Content-Type', 'application/json');
    }
    const res = await fetch(url, { ...options, headers });
    if (res.status === 401) {
      try { const data = await res.json(); showNotification(data.error || 'Unauthorized', 'error'); } catch {}
      logout();
      throw new Error('Unauthorized');
    }
    return res;
  }

  /* ----------------- Auth tab switching ----------------- */
  function switchAuthTab(which) {
    const tabs = ['login','signup','confirm'];
    tabs.forEach(t => {
      document.getElementById('tab' + capitalize(t)).classList.toggle('active', t === which);
      document.getElementById('card' + capitalize(t)).classList.toggle('hidden', t !== which);
    });
  }

  /* ----------------- App tab switching ----------------- */
  function switchAppTab(whichId) {
    const ids = ['UploadTab','JobsTab','AuditTab'];
    ids.forEach(id => {
      document.getElementById(id).classList.toggle('hidden', id !== whichId);
    });
    document.getElementById('tabUpload').classList.toggle('active', whichId === 'UploadTab');
    document.getElementById('tabJobs').classList.toggle('active', whichId === 'JobsTab');
    document.getElementById('tabAudit').classList.toggle('active', whichId === 'AuditTab');

    if (whichId === 'JobsTab') {
      if (liveEnabled) {
        startLive();
      } else {
        loadJobs();
        startPolling();
      }
    } else {
      // leaving Jobs tab—close SSE & stop polling to save resources
      stopLive(true);
      stopPolling();
      if (whichId === 'AuditTab') loadAudit();
    }
  }

  /* ----------------- SSE live updates ----------------- */
  function startLive() {
    if (!authToken || es) return;
    es = new EventSource(`/api/v1/stream/jobs?token=${encodeURIComponent(authToken)}`);
    es.addEventListener("jobs", (evt) => {
      try {
        const payload = JSON.parse(evt.data);
        const jobs = payload.jobs || [];
        displayJobs(jobs, { page: 1, pages: 1 });
        stopPolling();
      } catch { /* ignore parse errors */ }
    });
    es.onerror = () => {
      stopLive(true);
      startPolling();
    };
  }
  function stopLive(silent = false) {
    if (es) { try { es.close(); } catch {} es = null; }
    if (!silent) { /* showNotification("Live updates stopped", "error"); */ }
  }
  function toggleLive(on) {
    liveEnabled = !!on;
    localStorage.setItem('liveEnabled', String(liveEnabled));
    if (liveEnabled) {
      startLive();
    } else {
      stopLive();
      startPolling(); // resume polling when live is off
    }
  }

  /* ----------------- Auth calls ----------------- */
  async function signup() {
    const username = document.getElementById('signupUsername').value.trim();
    const email = document.getElementById('signupEmail').value.trim();
    const password = document.getElementById('signupPassword').value;
    if (!username || !email || !password) return showNotification('Provide username, email, password', 'error');

    try {
      document.getElementById('btnSignup').disabled = true;
      const res = await apiFetch('/api/auth/signup', {
        method: 'POST',
        body: JSON.stringify({ username, email, password })
      });
      const data = await res.json();
      if (!res.ok) return showNotification(data.error || 'Sign-up failed', 'error');

      showNotification('Sign-up successful. Check your email for the code!');
      document.getElementById('confirmUsername').value = username;
      switchAuthTab('confirm');
    } catch (e) {
      showNotification(e.message, 'error');
    } finally {
      document.getElementById('btnSignup').disabled = false;
    }
  }

  async function confirmSignup() {
    const username = document.getElementById('confirmUsername').value.trim();
    const code = document.getElementById('confirmCode').value.trim();
    if (!username || !code) return showNotification('Provide username and confirmation code', 'error');
    try {
      document.getElementById('btnConfirm').disabled = true;
      const res = await apiFetch('/api/auth/confirm', {
        method: 'POST',
        body: JSON.stringify({ username, code })
      });
      const data = await res.json();
      if (!res.ok) return showNotification(data.error || 'Confirm failed', 'error');

      showNotification('Email confirmed. You can now login.');
      document.getElementById('loginUsername').value = username;
      switchAuthTab('login');
    } catch (e) {
      showNotification(e.message, 'error');
    } finally {
      document.getElementById('btnConfirm').disabled = false;
    }
  }

  async function resendCode() {
    const username = document.getElementById('confirmUsername').value.trim();
    if (!username) return showNotification('Enter your username first', 'error');
    try {
      const res = await apiFetch('/api/auth/resend-code', {
        method: 'POST',
        body: JSON.stringify({ username })
      });
      const data = await res.json();
      if (!res.ok) return showNotification(data.error || 'Could not resend', 'error');
      showNotification('Verification code sent again.');
    } catch (e) {
      showNotification(e.message, 'error');
    }
  }

  async function login() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    if (!username || !password) return showNotification('Enter username and password', 'error');

    try {
      document.getElementById('btnLogin').disabled = true;
      const res = await apiFetch('/api/auth/login', {
        method: 'POST',
        body: JSON.stringify({ username, password })
      });
      const data = await res.json();
      if (!res.ok) return showNotification(data.error || 'Login failed', 'error');

      authToken = data.idToken || data.token;
      if (!authToken) return showNotification('No token returned by server', 'error');

      currentUser = {
        username: data.user?.username || username,
        role: data.user?.role || (username === 'admin' ? 'admin' : 'user')
      };
      localStorage.setItem('authToken', authToken);
      localStorage.setItem('currentUser', JSON.stringify(currentUser));

      document.getElementById('authSection').classList.add('hidden');
      document.getElementById('appSection').classList.remove('hidden');
      document.getElementById('userName').textContent = currentUser.username;

      showNotification('Login successful!');
      switchAppTab('UploadTab');
      loadJobs();
    } catch (e) {
      showNotification(e.message, 'error');
    } finally {
      document.getElementById('btnLogin').disabled = false;
    }
  }

  function logout() {
    authToken = null; currentUser = null;
    localStorage.removeItem('authToken');
    localStorage.removeItem('currentUser');
    stopLive(true);
    stopPolling();
    document.getElementById('authSection').classList.remove('hidden');
    document.getElementById('appSection').classList.add('hidden');
    showNotification('Logged out');
  }

  /* ---------- Upload via S3 presigned URLs ---------- */
  async function uploadVideo() {
    const btn = document.getElementById('btnStart');
    const fileInput = document.getElementById('videoFile');
    if (!fileInput.files.length) return showNotification('Select a video file', 'error');

    const file = fileInput.files[0];
    const title = document.getElementById('title').value;
    const description = document.getElementById('description').value;
    const format = document.getElementById('format').value;
    const resolution = document.getElementById('resolution').value;

    try {
      btn.disabled = true;

      // 1) Request a presigned PUT URL from server
      const presignRes = await apiFetch('/api/v1/jobs/presign-upload', {
        method: 'POST',
        body: JSON.stringify({ filename: file.name, contentType: file.type })
      });
      const presignData = await presignRes.json();
      if (!presignRes.ok) return showNotification(presignData.error || 'Presign failed', 'error');

      // 2) Browser uploads the file directly to S3
      const putRes = await fetch(presignData.uploadUrl, {
        method: 'PUT',
        headers: { 'Content-Type': file.type || 'application/octet-stream' },
        body: file
      });
      if (!putRes.ok) return showNotification('S3 upload failed', 'error');

      // 3) Tell server to create the job & start transcoding
      const startRes = await apiFetch('/api/v1/jobs/start', {
        method: 'POST',
        body: JSON.stringify({
          videoId: presignData.videoId,
          rawKey: presignData.rawKey,
          title, description, format, resolution
        })
      });
      const startData = await startRes.json();
      if (!startRes.ok) return showNotification(startData.error || 'Start job failed', 'error');

      showNotification('Job created: ' + (startData.videoId || 'OK'));
      fileInput.value = '';
      switchAppTab('JobsTab');

      if (liveEnabled) startLive(); else startPolling();
    } catch (e) {
      showNotification(e.message, 'error');
    } finally {
      btn.disabled = false;
    }
  }

  /* ---------- Jobs / Listing ---------- */
  async function handleDownload(videoId) {
    try {
      const res = await apiFetch(`/api/v1/jobs/${encodeURIComponent(videoId)}/download`);
      const data = await res.json();
      if (res.ok && data.url) window.open(data.url, '_blank');
      else showNotification(data.error || 'Not ready', 'error');
    } catch (e) {
      showNotification(e.message, 'error');
    }
  }

  function displayJobs(jobs, pagination) {
    const wrap = document.getElementById('jobsList');
    if (!jobs || jobs.length === 0) {
      wrap.innerHTML = '<p>No jobs found</p>'; return;
    }
    let html = '<div>';
    jobs.forEach(job => {
      const filename = fileNameFromRawKey(job.rawKey);
      const statusUpper = String(job.status || '').toUpperCase();
      const statusClass = statusUpper.toLowerCase(); // queued/processing/completed/failed
      html += `
        <div class="job ${statusClass}">
          <h4 style="margin:0 0 6px">${filename || '(untitled video)'} <small class="muted">[${job.videoId}]</small></h4>
          <p style="margin:4px 0">Status: <strong>${statusUpper}</strong></p>
          <p style="margin:4px 0">Created: ${human(job.createdAt)}</p>
          ${job.completedAt ? `<p style="margin:4px 0">Completed: ${human(job.completedAt)}</p>` : ''}
          ${job.title ? `<p style="margin:4px 0">Title: ${job.title}</p>` : ''}
          ${job.description ? `<p style="margin:4px 0">Description: ${job.description}</p>` : ''}
          <p style="margin:4px 0">Format: ${job.formatRequested || '-'}, Resolution: ${job.resolutionRequested || '-'}</p>
          ${job.errorMessage ? `<p style="margin:4px 0;color:red">Error: ${job.errorMessage}</p>` : ''}
          ${statusUpper === 'COMPLETED' ? `<button onclick="handleDownload('${job.videoId}')">Download</button>` : ''}
        </div>`;
    });
    html += '</div>';
    wrap.innerHTML = html;
  }

  async function loadJobs() {
    const statusFilter = document.getElementById('statusFilter').value;
    const sortBy = document.getElementById('sortBy').value;
    const sortOrder = document.getElementById('sortOrder').value;

    let url = '/api/v1/jobs?';
    if (statusFilter) url += `status=${encodeURIComponent(statusFilter)}&`;
    url += `sortBy=${encodeURIComponent(sortBy)}&sortOrder=${encodeURIComponent(sortOrder)}`;

    try {
      const res = await apiFetch(url);
      const data = await res.json();
      if (!res.ok) return showNotification(data.error || 'Failed to load jobs', 'error');

      const jobs = data.jobs || [];
      displayJobs(jobs, data.pagination);
      const hasActive = jobs.some(j => {
        const s = String(j.status || '').toUpperCase();
        return s === 'QUEUED' || s === 'PROCESSING';
      });
      if (!liveEnabled) { if (hasActive) startPolling(); else stopPolling(); }
    } catch (e) {
      showNotification('Jobs loading error: ' + e.message, 'error');
    }
  }

  function startPolling() { stopPolling(); pollHandle = setInterval(loadJobs, 5000); }
  function stopPolling() { if (pollHandle) clearInterval(pollHandle); pollHandle = null; }

  /* ---------- Audit ---------- */
  function renderAudit(events) {
    const wrap = document.getElementById('auditList');
    if (!events || !events.length) { wrap.innerHTML = '<p>No recent activity found.</p>'; return; }
    let html = '<div>';
    events.forEach(e => {
      const details = e.details ? `<pre class="details">${JSON.stringify(e.details, null, 2)}</pre>` : '';
      html += `
        <div class="job" style="border-left-color:#666;">
          <div class="row" style="justify-content:space-between;margin-bottom:6px;">
            <strong>${e.action}</strong>
            <span class="muted">${humanTs(e.ts || e.timestamp || e.createdAt)}</span>
          </div>
          <div style="margin-top:4px;color:#333">
            ${e.videoId ? `VideoId: <code>${e.videoId}</code><br/>` : ''}
            ${e.username ? `User: <code>${e.username}</code><br/>` : ''}
          </div>
          ${details}
        </div>`;
    });
    html += '</div>';
    wrap.innerHTML = html;
  }

  async function loadAudit() {
    if (!authToken) return showNotification('Please login first', 'error');
    const action = document.getElementById('auditFilter')?.value || '';
    const qs = action ? `?action=${encodeURIComponent(action)}` : '';
    try {
      const res = await apiFetch(`/api/v1/audit/me${qs}`);
      const data = await res.json();
      if (!res.ok) return showNotification(data.error || 'Failed to load audit events', 'error');
      renderAudit(data.events || []);
    } catch (e) {
      showNotification('Audit load error: ' + e.message, 'error');
    }
  }

  /* ---------- Boot ---------- */
  function checkLoggedIn() {
    const savedToken = localStorage.getItem('authToken');
    const savedUser = localStorage.getItem('currentUser');
    const savedLive = localStorage.getItem('liveEnabled');
    liveEnabled = savedLive === 'true';
    document.getElementById('liveToggle').checked = liveEnabled;

    if (savedToken && savedUser) {
      authToken = savedToken;
      currentUser = JSON.parse(savedUser);
      document.getElementById('authSection').classList.add('hidden');
      document.getElementById('appSection').classList.remove('hidden');
      document.getElementById('userName').textContent = currentUser.username;
      switchAppTab('UploadTab');
      loadJobs();
      if (liveEnabled) startLive();
    }
  }
  checkLoggedIn();
</script>

</body>
</html>
